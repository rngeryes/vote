<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Flappy Bird MiniApp</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@700&display=swap');
        body {
            margin: 0;
            background: #70c5ce;
            font-family: 'SF Pro Display', Arial, sans-serif;
            overflow: hidden;
        }
        #game {
            display: block;
            margin: 0 auto;
            background: #70c5ce;
            touch-action: none;
        }
        #bottomBar {
            position: fixed;
            left: 0; bottom: 0;
            width: 100vw;
            height: 70px;
            background: rgba(255,255,255,0.95);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            justify-content: space-around;
            z-index: 10;
        }
        .bar-btn {
            flex: 1;
            text-align: center;
            font-size: 18px;
            color: #222;
            font-family: 'SF Pro Display', Arial, sans-serif;
            font-weight: 700;
            cursor: pointer;
        }
        .bar-btn.selected {
            color: #007aff;
        }
        #coins {
            position: fixed;
            top: 20px; right: 20px;
            background: rgba(255,255,255,0.8);
            border-radius: 18px;
            padding: 8px 18px;
            font-size: 20px;
            font-family: 'SF Pro Display', Arial, sans-serif;
            font-weight: 700;
            color: #222;
            box-shadow: 0 2px 8px rgba(0,0,0,0.09);
            z-index: 10;
            text-shadow: 0 2px 6px #fff, 0 0 2px #007aff;
        }
        /* –ú–∞–≥–∞–∑–∏–Ω */
        #shopModal {
            position: fixed;
            left: 0; top: 0;
            width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.35);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        #shopContent {
            background: #fff;
            border-radius: 18px;
            padding: 24px;
            width: 90vw;
            max-width: 360px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.12);
            text-align: center;
        }
        .skin-btn {
            margin: 10px;
            padding: 10px 20px;
            border: none;
            border-radius: 12px;
            background: #f0f0f0;
            font-size: 18px;
            font-family: 'SF Pro Display', Arial, sans-serif;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .skin-btn.selected {
            background: #007aff;
            color: #fff;
        }
        .skin-preview {
            width: 48px; height: 48px;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        /* –¢–µ–Ω–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ */
        .shadow {
            text-shadow: 0 2px 6px #222, 0 0 2px #fff;
        }
    </style>
</head>
<body>
<canvas id="game" width="360" height="600"></canvas>
<div id="coins">0 ü™ô</div>
<div id="bottomBar">
    <div class="bar-btn selected" id="btnGame">–ò–≥—Ä–∞</div>
    <div class="bar-btn" id="btnShop">–°–∫–∏–Ω—ã</div>
    <div class="bar-btn" id="btnSettings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
</div>
<div id="shopModal">
    <div id="shopContent">
        <h2 class="shadow">–ú–∞–≥–∞–∑–∏–Ω —Å–∫–∏–Ω–æ–≤</h2>
        <div>
            <button class="skin-btn" data-skin="yellow"><span class="skin-preview" style="background:gold;border-radius:50%"></span>–ñ—ë–ª—Ç–∞—è (0ü™ô)</button>
            <button class="skin-btn" data-skin="blue"><span class="skin-preview" style="background:deepskyblue;border-radius:50%"></span>–ì–æ–ª—É–±–∞—è (10ü™ô)</button>
            <button class="skin-btn" data-skin="red"><span class="skin-preview" style="background:#ff5252;border-radius:50%"></span>–ö—Ä–∞—Å–Ω–∞—è (20ü™ô)</button>
        </div>
        <div style="margin-top:16px;">
            <button class="skin-btn" onclick="closeShop()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
/* === Telegram Mini App: –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ö–µ–¥–µ—Ä === */
if(window.Telegram && Telegram.WebApp) {
    Telegram.WebApp.expand();
    Telegram.WebApp.setHeaderColor('rgba(0,0,0,0)');
    Telegram.WebApp.setBackgroundColor('#70c5ce');
}

/* === –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ === */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let coins = parseInt(localStorage.getItem('flappy_coins') || '0');
let selectedSkin = localStorage.getItem('flappy_skin') || 'yellow';
let ownedSkins = JSON.parse(localStorage.getItem('flappy_skins') || '["yellow"]');
let gameState = 'start'; // start, playing, gameover
let score = 0;
let pipes = [];
let bird = {};
let pipeTimer = 0;
let gravity = 0.32;
let flap = -6.5;
let pipeGap = 170;
let pipeSpeed = 1.4;
let groundHeight = 80;
let lastTap = 0;

/* === –°–∫–∏–Ω—ã === */
const skins = {
    yellow: { color: 'gold', price: 0 },
    blue:   { color: 'deepskyblue', price: 10 },
    red:    { color: '#ff5252', price: 20 }
};

/* === –§—É–Ω–∫—Ü–∏–∏ –º–æ–Ω–µ—Ç === */
function saveCoins() {
    localStorage.setItem('flappy_coins', coins);
}
function updateCoins() {
    document.getElementById('coins').innerHTML = coins + ' ü™ô';
}

/* === –ú–∞–≥–∞–∑–∏–Ω —Å–∫–∏–Ω–æ–≤ === */
function openShop() {
    document.getElementById('shopModal').style.display = 'flex';
    // –û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∫–∏–Ω
    document.querySelectorAll('.skin-btn').forEach(btn => {
        btn.classList.remove('selected');
        if(btn.dataset.skin === selectedSkin) btn.classList.add('selected');
        btn.onclick = function() {
            let skin = btn.dataset.skin;
            if(!skin) return;
            if(ownedSkins.includes(skin)) {
                selectedSkin = skin;
                localStorage.setItem('flappy_skin', selectedSkin);
                document.querySelectorAll('.skin-btn').forEach(b=>b.classList.remove('selected'));
                btn.classList.add('selected');
                closeShop();
                draw();
            } else {
                // –ü–æ–∫—É–ø–∫–∞
                let price = skins[skin].price;
                if(coins >= price) {
                    coins -= price;
                    ownedSkins.push(skin);
                    localStorage.setItem('flappy_skins', JSON.stringify(ownedSkins));
                    saveCoins();
                    updateCoins();
                    selectedSkin = skin;
                    localStorage.setItem('flappy_skin', selectedSkin);
                    document.querySelectorAll('.skin-btn').forEach(b=>b.classList.remove('selected'));
                    btn.classList.add('selected');
                    closeShop();
                    draw();
                } else {
                    alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!');
                }
            }
        }
    });
}
function closeShop() {
    document.getElementById('shopModal').style.display = 'none';
}

/* === –ù–∞–≤–∏–≥–∞—Ü–∏—è –Ω–∏–∂–Ω–µ–≥–æ –±–∞—Ä–∞ === */
document.getElementById('btnGame').onclick = function() {
    this.classList.add('selected');
    document.getElementById('btnShop').classList.remove('selected');
    document.getElementById('btnSettings').classList.remove('selected');
    closeShop();
};
document.getElementById('btnShop').onclick = function() {
    this.classList.add('selected');
    document.getElementById('btnGame').classList.remove('selected');
    document.getElementById('btnSettings').classList.remove('selected');
    openShop();
};
document.getElementById('btnSettings').onclick = function() {
    this.classList.add('selected');
    document.getElementById('btnGame').classList.remove('selected');
    document.getElementById('btnShop').classList.remove('selected');
    alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã üôÇ');
};

/* === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ç–∏—Ü—ã === */
function resetBird() {
    bird = {
        x: 80,
        y: canvas.height/2,
        vy: 0,
        w: 34,
        h: 34
    };
}

/* === –†–∏—Å—É–µ–º –ø—Ç–∏—Ü—É —Å —Ç–µ–Ω—å—é === */
function drawBird() {
    // –¢–µ–Ω—å
    ctx.save();
    ctx.globalAlpha = 0.18;
    ctx.beginPath();
    ctx.ellipse(bird.x+bird.w/2, bird.y+bird.h-2, 18, 6, 0, 0, 2*Math.PI);
    ctx.fillStyle = "#222";
    ctx.fill();
    ctx.restore();
    // –ü—Ç–∏—Ü–∞
    ctx.save();
    ctx.beginPath();
    ctx.arc(bird.x+17, bird.y+17, 17, 0, 2*Math.PI);
    ctx.fillStyle = skins[selectedSkin].color;
    ctx.shadowColor = "#fff";
    ctx.shadowBlur = 8;
    ctx.fill();
    ctx.restore();
    // –ì–ª–∞–∑
    ctx.beginPath();
    ctx.arc(bird.x+23, bird.y+15, 5, 0, 2*Math.PI);
    ctx.fillStyle = "#fff";
    ctx.fill();
    ctx.beginPath();
    ctx.arc(bird.x+25, bird.y+15, 2, 0, 2*Math.PI);
    ctx.fillStyle = "#222";
    ctx.fill();
    // –ö–ª—é–≤
    ctx.beginPath();
    ctx.moveTo(bird.x+32, bird.y+20);
    ctx.lineTo(bird.x+40, bird.y+22);
    ctx.lineTo(bird.x+32, bird.y+24);
    ctx.closePath();
    ctx.fillStyle = "#ffb300";
    ctx.fill();
    // –û–±–≤–æ–¥–∫–∞
    ctx.lineWidth = 2;
    ctx.strokeStyle = "#222";
    ctx.strokeRect(bird.x, bird.y, bird.w, bird.h);
}

/* === –†–∏—Å—É–µ–º —Ç—Ä—É–±—ã === */
function drawPipes() {
    pipes.forEach(pipe => {
        // –í–µ—Ä—Ö–Ω—è—è —Ç—Ä—É–±–∞
        ctx.save();
        ctx.fillStyle = "#1edc36";
        ctx.fillRect(pipe.x, 0, 52, pipe.top);
        ctx.fillStyle = "#0a8e21";
        ctx.fillRect(pipe.x, pipe.top-18, 52, 18);
        ctx.restore();
        // –ù–∏–∂–Ω—è—è —Ç—Ä—É–±–∞
        ctx.save();
        ctx.fillStyle = "#1edc36";
        ctx.fillRect(pipe.x, pipe.bottom, 52, canvas.height - pipe.bottom - groundHeight);
        ctx.fillStyle = "#0a8e21";
        ctx.fillRect(pipe.x, pipe.bottom, 52, 18);
        ctx.restore();
    });
}

/* === –†–∏—Å—É–µ–º —Ñ–æ–Ω === */
function drawBackground() {
    // –ù–µ–±–æ —É–∂–µ –µ—Å—Ç—å
    // –û–±–ª–∞–∫–∞
    ctx.save();
    ctx.globalAlpha = 0.13;
    for(let i=0;i<3;i++) {
        ctx.beginPath();
        ctx.arc(80+i*120, 160, 50, 0, 2*Math.PI);
        ctx.arc(120+i*120, 140, 40, 0, 2*Math.PI);
        ctx.arc(160+i*120, 170, 30, 0, 2*Math.PI);
        ctx.fillStyle = "#fff";
        ctx.fill();
    }
    ctx.globalAlpha = 1;
    ctx.restore();
    // –ì–æ—Ä–æ–¥
    ctx.save();
    ctx.globalAlpha = 0.18;
    ctx.fillStyle = "#b2e6f2";
    for(let i=0;i<8;i++) {
        ctx.fillRect(i*50, 480, 30, 80);
    }
    ctx.restore();
}

/* === –†–∏—Å—É–µ–º –∑–µ–º–ª—é === */
function drawGround() {
    ctx.save();
    ctx.fillStyle = "#ded895";
    ctx.fillRect(0, canvas.height-groundHeight, canvas.width, groundHeight);
    ctx.restore();
}

/* === –†–∏—Å—É–µ–º —Å—á–µ—Ç === */
function drawScore() {
    ctx.save();
    ctx.font = "bold 48px 'SF Pro Display', Arial, sans-serif";
    ctx.fillStyle = "#fff";
    ctx.textAlign = "center";
    ctx.shadowColor = "#222";
    ctx.shadowBlur = 8;
    ctx.fillText(score, canvas.width/2, 80);
    ctx.restore();
}

/* === –û—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–Ω–¥–µ—Ä === */
function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawBackground();
    drawPipes();
    drawGround();
    drawBird();
    if(gameState === 'playing') drawScore();
    if(gameState === 'start') {
        ctx.save();
        ctx.font = "bold 32px 'SF Pro Display', Arial, sans-serif";
        ctx.fillStyle = "#fff";
        ctx.textAlign = "center";
        ctx.shadowColor = "#222";
        ctx.shadowBlur = 8;
        ctx.fillText("–¢–∞–ø–Ω–∏—Ç–µ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å", canvas.width/2, canvas.height/2-40);
        ctx.font = "bold 22px 'SF Pro Display', Arial, sans-serif";
        ctx.fillText("Flappy Bird MiniApp", canvas.width/2, canvas.height/2+8);
        ctx.restore();
    }
    if(gameState === 'gameover') {
        ctx.save();
        ctx.font = "bold 38px 'SF Pro Display', Arial, sans-serif";
        ctx.fillStyle = "#fff";
        ctx.textAlign = "center";
        ctx.shadowColor = "#222";
        ctx.shadowBlur = 8;
        ctx.fillText("Game Over", canvas.width/2, canvas.height/2-30);
        ctx.font = "bold 22px 'SF Pro Display', Arial, sans-serif";
        ctx.fillText("–°—á–µ—Ç: "+score, canvas.width/2, canvas.height/2+8);
        ctx.fillText("–¢–∞–ø–Ω–∏—Ç–µ –¥–ª—è —Ä–µ—Å—Ç–∞—Ä—Ç–∞", canvas.width/2, canvas.height/2+38);
        ctx.restore();
    }
}

/* === –û—Å–Ω–æ–≤–Ω–æ–π –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª === */
function gameLoop() {
    if(gameState !== 'playing') {
        draw();
        return;
    }
    // –§–∏–∑–∏–∫–∞ –ø—Ç–∏—Ü—ã
    bird.vy += gravity;
    bird.y += bird.vy;
    // –î–≤–∏–∂–µ–Ω–∏–µ —Ç—Ä—É–±
    pipes.forEach(pipe => pipe.x -= pipeSpeed);
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç—Ä—É–±
    pipeTimer += 1;
    if(pipeTimer > 90) {
        let top = Math.random()*(canvas.height-pipeGap-groundHeight-80)+30;
        pipes.push({
            x: canvas.width,
            top: top,
            bottom: top+pipeGap,
            passed: false
        });
        pipeTimer = 0;
    }
    // –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ç—Ä—É–±
    if(pipes.length && pipes[0].x < -60) pipes.shift();
    // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è
    let collision = false;
    pipes.forEach(pipe => {
        if(!pipe.passed && pipe.x+52 < bird.x) {
            score++;
            coins++;
            pipe.passed = true;
            saveCoins();
            updateCoins();
        }
        if(
            bird.x+bird.w > pipe.x && bird.x < pipe.x+52 &&
            (bird.y < pipe.top || bird.y+bird.h > pipe.bottom)
        ) collision = true;
    });
    if(bird.y+bird.h > canvas.height-groundHeight || bird.y < 0) collision = true;
    if(collision) {
        gameState = 'gameover';
        setTimeout(()=>draw(), 100); // –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
        return;
    }
    draw();
    requestAnimationFrame(gameLoop);
}

/* === –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞–ø–æ–≤ === */
function jump() {
    if(gameState === 'start') {
        gameState = 'playing';
        score = 0;
        pipes = [];
        pipeTimer = 0;
        resetBird();
        gameLoop();
    } else if(gameState === 'playing') {
        bird.vy = flap;
    } else if(gameState === 'gameover') {
        setTimeout(()=>{
            gameState = 'start';
            resetBird();
            pipes = [];
            pipeTimer = 0;
            draw();
        }, 350); // –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
    }
}
canvas.addEventListener('touchstart', e => {
    e.preventDefault();
    jump();
});
canvas.addEventListener('mousedown', e => {
    e.preventDefault();
    jump();
});

/* === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è === */
function init() {
    updateCoins();
    resetBird();
    draw();
}
init();

/* === –û–∫–Ω–æ —Ä–µ—Å–∞–π–∑–∞ (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö) === */
window.addEventListener('resize', ()=>{
    // –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∞–¥–∞–ø—Ç–∏–≤, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
});
</script>
</body>
</html>
